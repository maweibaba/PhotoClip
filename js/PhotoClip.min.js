/* PhotoClip v2.0.3 | Relying on the plug-in [jquery.js] [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(o,t){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):o.PhotoClip=t(o.jQuery,o.IScroll,o.Hammer,o.lrz)}(this,function(o,t,e,n){"use strict";function i(t,e){var n=o.extend({},s,e);a.call(this,t,n)}function a(i,a){function s(){pt=!0,mt.append(this),w(rt,function(){st=this.naturalWidth,ct=this.naturalHeight},this),w(ht,function(){u()}),Y.call(E,this)}function l(){var o={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};Tt=new t(dt[0],o)}function u(){Lt=0,qt=0,At=0,lt=st,ut=ct,mt.css({width:st,height:ct}),j(mt,Lt,qt,At),p(st,ct),Tt.zoom(Tt.options.zoomStart);var o=.5*(V-st*Tt.scale),t=.5*(_-ct*Tt.scale);Tt.scrollTo(o,t)}function p(o,t){T(o,t),Tt.scale<Tt.options.zoomMin&&Tt.zoom(Tt.options.zoomMin),ht.css({width:o,height:t}),dt.append(ht),Tt.refresh()}function f(){var o=!!navigator.userAgent.match(/mobile/i);if(o){zt=new e(ht[0]),zt.add(new e.Rotate);var t,n;zt.on("rotatemove",function(o){St||(t=o.rotation,t>180?t-=360:-180>t&&(t+=360),n=t>0?1:0>t?-1:0)}),zt.on("rotateend",function(o){St||Math.abs(t)>30&&(1==n?d(o.center):-1==n&&h(o.center))})}else ht.on("dblclick",function(o){d({x:o.clientX,y:o.clientY})})}function d(o){m(90,o)}function h(o){m(-90,o)}function m(o,t){if(!St){St=!0;var e;e=t?x(ht,t.x,t.y):y(ht,dt,.5*V,.5*_);var n=k(At,e),i=n.x,a=n.y,r=0,s=0,c=0,l=0,u=At+o;90==u||-270==u?(r=i+a,s=a-i,u>At?(c=ct-i-a,l=i-a):At>u&&(c=ct-a-(st-i),l=i+a-ct),lt=ct,ut=st):180==u||-180==u?(r=2*i,s=2*a,u>At?(c=st-i-(ct-a),l=ct-(i+a)):At>u&&(c=st-(i+a),l=ct-a-(st-i)),lt=st,ut=ct):270==u||-90==u?(r=i-a,s=i+a,u>At?(c=i+a-st,l=st-i-(ct-a)):At>u&&(c=a-i,l=st-i-a),lt=ct,ut=st):(0==u||360==u||-360==u)&&(r=0,s=0,u>At?(c=i-a,l=i+a-st):At>u&&(c=i+a-ct,l=a-i),lt=st,ut=ct),0==At?(Lt=0,qt=0):90==At||-270==At?(Lt-=i+a,qt-=a-i):180==At||-180==At?(Lt-=2*i,qt-=2*a):(270==At||-90==At)&&(Lt-=i-a,qt-=i+a),Lt=Lt.toFixed(2)-0,qt=qt.toFixed(2)-0,j(mt,Lt,qt,At,i,a),C(mt,Lt,qt,u,200,function(){St=!1,At=u%360,Lt+=r+c,qt+=s+l,Lt=Lt.toFixed(2)-0,qt=qt.toFixed(2)-0,j(mt,Lt,qt,At),Tt.scrollTo(Tt.x-c*Tt.scale,Tt.y-l*Tt.scale),p(lt,ut)})}}function g(){kt=document.createElement("canvas")}function v(){if(!pt)return console.log("当前没有图片可以裁剪!"),void $.call(E,null);var o=y(ht,dt),t=Tt.scale,e=kt.getContext("2d");e.clearRect(0,0,kt.width,kt.height),e.save(),et&&nt?(kt.width=et,kt.height=nt,e.scale(et/V*t,nt/_*t)):(kt.width=V/t,kt.height=_/t),e.translate(Lt-o.x/t,qt-o.y/t),e.rotate(At*Math.PI/180),e.drawImage(rt[0],0,0),e.restore();try{var n=kt.toDataURL(Q,H);gt.css("background-image","url("+n+")"),$.call(E,n)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}}function b(){q()}function y(o,t,e,n){e=e||0,n=n||0;var i,a;return w(o,function(){i=o.offset()}),w(t,function(){a=t.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function x(o,t,e){t=t||0,e=e||0;var n;return w(o,function(){n=o.offset()}),{x:t+Ct.scrollLeft()-n.left,y:e+Ct.scrollTop()-n.top}}function w(t,e,n){var i=o();o.each(t,function(t,e){for(var n,a=e instanceof jQuery?e:o(e),r=a.parents().addBack().filter(":hidden"),t=r.length;t--&&a.is(":hidden");)n=r.eq(t),"none"===n.css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(n||this),i.hide()}function k(o,t){var e=Tt.scale,n={};return 0==o?(n.x=t.x/e,n.y=t.y/e):90==o||-270==o?(n.x=t.y/e,n.y=ct-t.x/e):180==o||-180==o?(n.x=st-t.x/e,n.y=ct-t.y/e):(270==o||-90==o)&&(n.x=st-t.y/e,n.y=t.x/e),n}function z(o,t,e,n){var i=o/e,a=t/n;return i>a?i:a}function T(o,t){Tt.options.zoomMin=z(V,_,o,t),Tt.options.zoomMax=Math.max(1,Tt.options.zoomMin),Tt.options.zoomStart=Math.min(Tt.options.zoomMax,z(Mt,Ft,o,t))}function M(){rt&&rt.length&&(rt.off(),rt.remove(),delete rt[0])}function F(t){M(),rt=o("<img>").css({"user-select":"none","pointer-events":"none"}),it||(it=!0,X.call(E,rt[0])),rt.on("load",s),rt.attr("src",t)}function j(o,t,e,n,i,a){i=i||0,a=a||0;var r={};r[c+"transform"]="translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)",r[c+"transform-origin"]=i+"px "+a+"px",o.css(r)}function C(o,t,e,n,i,a){o.css(c+"transform"),o.css(c+"transition",c+"transform "+i+"ms"),o.one(r,function(){o.css(c+"transition",""),a.call(this)}),o.css(c+"transform","translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)")}function S(o){var t=o+"";return/%$/.test(t)}function L(){ft=o(i).css({"user-select":"none",overflow:"hidden"}),"static"==ft.css("position")&&ft.css("position","relative"),dt=o("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%"}).appendTo(ft),ht=o("<div class='photo-clip-moveLayer'>").appendTo(dt),mt=o("<div class='photo-clip-rotateLayer'>").appendTo(ht);var t=o("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(ft);vt=o("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(t),bt=o("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),yt=o("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),xt=o("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(t),wt=o("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(t),gt=o(D),gt.length&&gt.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function q(o,t){var e=ot,n=tt;if("number"==typeof o&&(ot=o),"number"==typeof t&&(tt=t),V=ot,_=tt,(J||K)&&(N=ot/tt),w(ft,function(){Mt=ft.width(),Ft=ft.height()}),J&&(V=Mt/100*parseFloat(J),K||(_=V/N)),K&&(_=Ft/100*parseFloat(K),J||(V=_*N)),dt.css({width:V,height:_,"margin-left":-V/2,"margin-top":-_/2}),vt.css({"margin-right":V/2,"margin-top":-_/2,"margin-bottom":-_/2}),bt.css({"margin-left":V/2,"margin-top":-_/2,"margin-bottom":-_/2}),yt.css({"margin-bottom":_/2}),xt.css({"margin-top":_/2}),wt.css({width:V,height:_,"margin-left":-V/2-1,"margin-top":-_/2-1}),lt&&ut){var i=(V-e)/2*Tt.scale,a=(_-n)/2*Tt.scale;Tt.scrollBy(i,a),p(lt,ut)}}function A(o){F(o)}function R(){at.off("change"),at=null,zt?(zt.off("rotatemove"),zt.off("rotateend"),zt.destroy(),zt=null):ht.off("dblclick"),Tt.destroy(),Tt=null,ft.empty(),ft=null,dt=null,ht=null,mt=null,gt.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),gt=null}var E=this,I=a.size,W=a.adaptive,P=a.outputSize,Q=a.outputType||"image/jpeg",H=a.outputQuality,O=a.file,B=a.source,D=a.view,U=a.ok,X=a.loadStart,Y=a.loadComplete,Z=a.loadError,$=a.clipFinish,G=a.lrzOption;o.isArray(I)||(I=[260,260]),o.isArray(P)||(P=[0,0]);var J,K,N,V,_,ot=I[0]||260,tt=I[1]||260,et=Math.max(P[0],0),nt=Math.max(P[1],0);o.isArray(W)&&(W[0]&&(J=S(W[0])?W[0]:!1),W[1]&&(K=S(W[1])?W[1]:!1)),"jpg"===Q?Q="image/jpeg":"png"===Q&&(Q="image/png");var it=!1;if(O)if(window.FileReader){var at=o(O);at.length&&(at.attr("accept","image/jpeg, image/x-png, image/gif"),at.on("change",function(){if(this.files.length){var o=this.files[0];if(!/image\/\w+/.test(o.type))return console.log("图片格式不正确，请选择正确格式的图片文件！"),Z.call(E,"Image format error"),!1;it||(it=!0,X.call(E,o));var t=new FileReader;t.onprogress=function(o){console.log((o.loaded/o.total*100).toFixed()+"%")},t.onload=function(){n(o,G).then(function(o){F(o.base64),it=!1}).catch(function(o){console.log("图片处理失败"),Z.call(E,o),it=!1})},t.onerror=function(o){console.log("图片加载失败"),Z.call(E,o),it=!1},t.readAsDataURL(o)}}),at.click(function(){this.value=""}))}else alert("您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件上传图片！");B&&A(B);var rt,st,ct,lt,ut,pt,ft,dt,ht,mt,gt,vt,bt,yt,xt,wt,kt,zt,Tt,Mt,Ft;L(),l(),f(),g();var jt=o(U);jt.length&&jt.click(function(){v()});var Ct=o(window);b(),Ct.resize(b);var St,Lt,qt,At;E.setSize=q,E.setImg=A,E.rotateCW=d,E.rotateCCW=h,E.destroy=R}var r,s={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",outputQuality:.8,file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var o,t={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(t){return o?o+t:t.toLowerCase()};for(var i in t)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",o=t[i];break}r=n("TransitionEnd")}(),i});